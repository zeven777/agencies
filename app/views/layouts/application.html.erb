<!DOCTYPE html>
<html>
<head>
  <title>Agencytest</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/3.0.3/normalize.min.css">
  <%= stylesheet_link_tag    'application', media: 'all', 'data-turbolinks-track' => true %>
  <script src= "https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular.min.js"></script>
  <script src= "https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/amcharts/3.13.0/amcharts.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/amcharts/3.13.0/serial.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/amcharts/3.13.0/themes/light.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/amcharts/3.13.0/pie.js"></script>
  <%= javascript_include_tag 'application', 'data-turbolinks-track' => true %>
  <script>

  var app = angular.module("myApp", []);

  var datos = new Array();
  var iataCount = new Array();
  var vectorIata = new Array();
  var myObjeto = {};


  app.controller("AgencyController", function($http, $scope, $q, $log){
  	var defered = $q.defer();
    var promise = defered.promise;


    getAll();

    function getAll () {
      $http.get('https://stormy-castle-4138.herokuapp.com/agencies.json')
        .success(function(data) {
          defered.resolve(data);
    		})
    		.error(function(err) {
          defered.reject(err)
        });
      return promise;
    }

    // +++++++++++++++++++  START FUNCTION AFTER LOAD JSON +++++++++++++++++++++++++++++++


   	defered.promise.then(function(data){
   		$log.log("Promesa cumplida");

   		$scope.months = data;
    	$scope.mensaje = data;
      $scope.mundo ="_";

      var iataCompare = data[0].iata;
      var t = 1;
      iataCount[0] = data[0].iata;

  		for(var i=0; i < data.length; i++){

        vectorIata[i] = data[i].iata;

        if(iataCompare != data[i].iata){
          iataCompare = data[i].iata;
          iataCount[t] = data[i].iata;
          t++;
        }
    	}

      $scope.linkAgency = iataCount.slice();

      function cargaAgencia(valor, datos){
        var showAgency = new Array();
        $scope.mundo = valor;

        var k = 0;

        for(i=0; i<= datos.length; i++){

          if (valor == vectorIata[i]) {
            showAgency[k] = datos[i];
            k++;
          }
        }



        // SET EMPTY VALUES VECTOR ###########################


        if(showAgency.length < 25){

          for(var i=1+showAgency.length; i < 25; i++){
            showAgency[i] = showAgency[0].slice();
            showAgency[i].id = 0;
            showAgency[i].month = "";
            showAgency[i].negocio = "";
            showAgency[i].revenue = 0;
            showAgency[i].cabina = "";
            showAgency[i].name = "";
          }

        }

        //for(var i=0; i < 25; i++){
        $log.log(showAgency);
        //}

    }

    $scope.pedirValor = function(valor){
      datos = data.slice();
      cargaAgencia(valor, datos);
    }


  });

});
</script>
  <%= csrf_meta_tags %>
</head>
<body>
  <%= yield %>
</body>
</html>
